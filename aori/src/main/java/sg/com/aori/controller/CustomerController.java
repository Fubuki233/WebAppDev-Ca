
/**
 * Detailed description of the class.
 *
 * @author Sun Rui
 * @date 2025-10-08
 * @version 1.2
 */

package sg.com.aori.controller;

import java.net.URI;
import java.util.Optional;
import jakarta.validation.Valid;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import sg.com.aori.service.CustomerService;
import sg.com.aori.model.Customer;
import sg.com.aori.model.CustomerAddress;
import sg.com.aori.interfaces.ICreateAccount;

/**
 * REST controller for the "Create Account" use case.
 * Endpoints focus on creating a Customer and (optionally) adding an initial
 * CustomerAddress.
 */
@RestController
@RequestMapping("/api/customers")
public class CustomerController {

    /** Service handling the Create Account use case */
    private final ICreateAccount createAccountService;

    private final CustomerService customerService;

    public CustomerController(ICreateAccount createAccountService, CustomerService customerService) {
        this.createAccountService = createAccountService;
        this.customerService = customerService;
    }

    /**
     * Create a new customer.
     *
     * param: customer Request body containing a fully-prepared Customer entity (id
     * auto-generated by entity).
     * return: 201 Created with the persisted Customer in body and Location header
     * pointing to /api/customers/{id}.
     * throws: IllegalArgumentException if input is invalid.
     */
    @PostMapping
    public ResponseEntity<Customer> createCustomer(@Valid @RequestBody Customer customer) {
        customer.setCustomerId(java.util.UUID.randomUUID().toString());
        Customer saved = createAccountService.createCustomer(customer);
        return ResponseEntity
                .created(URI.create("/api/customers/" + saved.getCustomerId()))
                .body(saved);
    }

    /**
     * Get a customer by email.
     *
     * param: email Email address to search for (as query parameter).
     * return: 200 OK with Customer if found, otherwise 404 Not Found.
     * throws: IllegalArgumentException if input is invalid.
     */
    @GetMapping
    public ResponseEntity<Customer> getCustomerByEmail(@RequestParam("email") String email) {
        Optional<Customer> opt = createAccountService.getCustomerByEmail(email);
        return opt.map(ResponseEntity::ok)
                .orElseGet(() -> ResponseEntity.notFound().build());
    }

    /**
     * Add an initial address for the given customer.
     * If the customer has no default address yet, this address will be marked as
     * default.
     *
     * param: customerId The Customer primary key (String UUID) from the path.
     * param: address The address payload; its customerId will be enforced to match
     * path variable.
     * return: 201 Created with the persisted CustomerAddress in body and Location
     * header pointing to /api/customers/{id}/addresses.
     * throws: IllegalArgumentException if input is invalid.
     */
    @PostMapping("/{customerId}/addresses")
    public ResponseEntity<CustomerAddress> addInitialAddress(@PathVariable String customerId,
            @Valid @RequestBody CustomerAddress address) {
        // 以路径变量为准，避免与 body 内不一致
        address.setCustomerId(customerId);
        CustomerAddress saved = createAccountService.addInitialAddress(address);
        return ResponseEntity
                .created(URI.create("/api/customers/" + customerId + "/addresses"))
                .body(saved);
    }

    @GetMapping("/{customerId}")
    public ResponseEntity<Customer> getCustomerById(@PathVariable String customerId) {
        Optional<Customer> customer = customerService.findCustomerById(customerId);
        return customer.map(ResponseEntity::ok)
                .orElseGet(() -> ResponseEntity.notFound().build());
    }

}
