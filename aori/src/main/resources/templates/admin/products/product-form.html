<!-- 
 * Aori Admin Portal Product Form
 * 
 * @author Tang Ying Chun
 * @date 2025-10-10 (v1.0), 2025-10-14 (v2.0), 2025-10-15 (v3.0)
 * @version 1.0 - Initial product form 
 * version 2.0 - Reformatted form; several fixes to link with SKU-related data; 
 * version 3.0 - Updated SKU table to correctly display quantities, included all relevant form fields. Added some basic validation.
 */ 
 -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title th:text="${product.productId == null} ? 'Add Product' : 'Edit Product'">Add/Edit Product</title>
</head>

<body>

    <section layout:fragment="content">
        <h2 th:text="${product.productId == null} ? 'Add New Product' : 'Edit Product'">Add/Edit Product</h2>
        <hr>

        <!-- Error Message Display -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <strong th:text="${error}"></strong>
        </div>

        <!-- Product Form -->

        <form th:action="@{/admin/products/save}" th:object="${product}" method="post" class="needs-validation"
            novalidate>
            <input type="hidden" th:field="*{productId}" />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="productName" class="form-label">Product Name</label>
                    <input type="text" class="form-control" id="productName" th:field="*{productName}" required minlength="3" maxlength="150">
                    <div class="form-text">Name should be between 3 and 150 characters.</div>
                    <div class="invalid-feedback">Product name is required.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="productCode" class="form-label">Product Code</label>
                    <input type="text" class="form-control" id="productCode" th:field="*{productCode}" required pattern="^[A-Za-z0-9\-]+$" title="Product code can only contain letters, numbers, and hyphens.">
                    <div class="form-text">E.g. AORI-ABC-123. Refer to database for existing codes.</div>
                    <div class="invalid-feedback">Product code is required.</div>
                </div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" th:field="*{description}" rows="3"></textarea>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" th:field="*{categoryId}" required>
                        <option value="">-- Select a Category --</option>
                        <option th:each="cat : ${categories}" th:value="${cat.categoryId}" th:text="${cat.categoryName}"></option>
                    </select>
                    <div class="invalid-feedback">Category is required.</div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="collection" class="form-label">Collection</label>
                    <input type="text" class="form-control" id="collection" th:field="*{collection}" required minlength="3" maxlength="100">
                    <div class="form-text">Collection name should be between 3 and 100 characters.</div>
                    <div class="invalid-feedback">Collection is required.</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="material" class="form-label">Material</label>
                    <input type="text" class="form-control" id="material" th:field="*{material}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="season" class="form-label">Season</label>
                    <select class="form-select" id="season" th:field="*{season}">
                        <option value="">-- Select a Season --</option>
                        <option th:each="s : ${allSeasons}" th:value="${s}" th:text="${s}"></option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="careInstructions" class="form-label">Care Instructions</label>
                    <textarea class="form-control" id="careInstructions" th:field="*{careInstructions}" rows="3"></textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="image" class="form-label">Image URL</label>
                    <input type="url" class="form-control" id="image" th:field="*{image}" placeholder="https://example.com/image.jpg">
                    <div class="invalid-feedback">Key in a valid URL or leave blank if no image is available.</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="rating" class="form-label">Rating (0.0 - 5.0)</label>
                    <input type="number" step="0.1" min="0" max="5" class="form-control" id="rating" th:field="*{rating}">
                    <div class="form-text">If left blank, this will show a null value.</div>
                    <div class="invalid-feedback">Please enter a rating between 0.0 and 5.0.</div>
                    </div>
                <div class="col-md-6 mb-3">
                    <label for="tags" class="form-label">Tags</label>
                    <input type="text" class="form-control" id="tags" th:field="*{tags}" placeholder="e.g. best-seller, new-arrival">
                    <div class="form-text">Add a comma in between tags.</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="price" class="form-label">Price</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="price" th:field="*{price}" required>
                    <div class="invalid-feedback">A valid price is required.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="stockQuantity" class="form-label">Total Stock Quantity</label>
                    <input type="number" class="form-control" id="stockQuantity" th:field="*{stockQuantity}" required readonly>
                    <div class="invalid-feedback">Stock quantity is required.</div>
                </div>
            </div>

            <div class="mb-3 card">
                <div class="card-header">Size Variants & Stock</div>
                <div class="card-body" id="size-variants-container">
                    <p class="text-muted">Select available sizes. Stock quantities are managed per color variant below.</p>
                    <!-- Size selection checkboxes will be generated by JS -->
                    <input type="hidden" id="sizeJson" name="sizeJson" th:value="${sizeJson}" />
                    <input type="hidden" id="skuQuantitiesJson" name="skuQuantitiesJson" />
                </div>
            </div>

            <div class="mb-3 card">
                <div class="card-header">Colors</div>
                <div class="card-body">
                    <div id="color-container">
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-color-btn">Add
                        Color</button>
                    <input type="hidden" id="colorJson" name="colorJson" th:value="${colorJson}" />
                </div>
            </div>

            <button type="submit" class="btn btn-dark">Save Product</button>
            <a th:href="@{/admin/products}" class="btn btn-secondary">Cancel</a>
        </form>
    </section>

    <th:block layout:fragment="scripts">
        <script>
            // --- START: Data from Controller ---
            const allSizes = /*[[${allSizes}]]*/['XS', 'S', 'M', 'L', 'XL', 'XXL'];
            const initialSizeJson = document.getElementById('sizeJson').value;
            const initialColorJson = document.getElementById('colorJson').value;
            const initialSkuQuantities = /*[[${skuQuantities}]]*/ null;
            // --- END: Data from Controller ---

            document.addEventListener('DOMContentLoaded', function () {
                const sizeContainer = document.getElementById('size-variants-container');

                // 1. Build Size Checkboxes
                const sizeRow = document.createElement('div');
                sizeRow.className = 'row';
                allSizes.forEach(size => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4';
                    col.innerHTML = `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input size-checkbox" type="checkbox" value="${size}" id="size-${size}">
                            <label class="form-check-label" for="size-${size}">${size}</label>
                        </div>
                    `;
                    sizeRow.appendChild(col);
                });
                sizeContainer.appendChild(sizeRow);

                // 2. Pre-populate selected sizes
                if (initialSizeJson) {
                    try {
                        const selectedSizes = JSON.parse(initialSizeJson);
                        selectedSizes.forEach(size => {
                            const checkbox = document.getElementById('size-' + size);
                            if (checkbox) checkbox.checked = true;
                        });
                    } catch (e) {
                        console.error('Could not parse size JSON:', initialSizeJson);
                    }
                }

                // 3. Pre-populate colors and their SKU quantities
                if (initialColorJson) {
                    try {
                        const colors = JSON.parse(initialColorJson);
                        colors.forEach(hexValue => { 
                            // Ensure initialSkuQuantities is not null and the color key exists
                            const quantities = (initialSkuQuantities && initialSkuQuantities[hexValue]) 
                                                ? initialSkuQuantities[hexValue] 
                                                : {};
                            createColorRow(hexValue, quantities);
                        });
                        updateTotalStock();
                    } catch (e) {
                        console.error('Could not parse color JSON:', initialColorJson);
                    }
                }

                // 4. Add event listeners
                sizeContainer.addEventListener('change', updateTotalStock);
            });

            // --- START: Refactored color row creation ---
            const colorContainer = document.getElementById('color-container');
            const addColorBtn = document.getElementById('add-color-btn');

            function createColorRow(value = '#000000', quantities = {}) {
                const colorRow = document.createElement('div');
                colorRow.className = 'color-variant-card card mb-3';
                
                let sizeInputsHtml = '<div class="row mt-2">';
                allSizes.forEach(size => {
                    const qty = quantities[size] || 0;
                    sizeInputsHtml += `
                        <div class="col-md-4">
                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">${size}</span>
                                <input type="number" class="form-control sku-quantity-input" data-size="${size}" value="${qty}" min="0" placeholder="Qty">
                            </div>
                        </div>
                    `;
                });
                sizeInputsHtml += '</div>';

                colorRow.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="input-group" style="max-width: 200px;">
                                <span class="input-group-text">Color</span>
                                <input type="color" class="form-control form-control-color color-value" value="${value}" title="Choose your color">
                            </div>
                            <button class="btn btn-sm btn-outline-danger remove-color-btn" type="button">Remove Color</button>
                        </div>
                        <hr>
                        <p class="card-subtitle mb-2 text-muted small">Enter stock for each size variant of this color.</p>
                        ${sizeInputsHtml}
                    </div>
                `;
                colorContainer.appendChild(colorRow);
                colorRow.querySelector('.sku-quantity-input').addEventListener('input', updateTotalStock);
                colorRow.querySelector('.remove-color-btn').addEventListener('click', () => {
                    colorRow.remove();
                    updateTotalStock();
                });
            }

            addColorBtn.addEventListener('click', () => createColorRow());
            // --- END: Refactored color row creation ---

            // Bootstrap Form Validation
            (() => {
                'use strict'
                const forms = document.querySelectorAll('.needs-validation')
                Array.from(forms).forEach(form => {
                    form.addEventListener('submit', event => {
                        // Serialize all dynamic fields before submission
                        serializeSizeAndColor();

                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
            })()

            function updateTotalStock() {
                let total = 0;
                document.querySelectorAll('.sku-quantity-input').forEach(input => {
                    const val = parseInt(input.value, 10);
                    if (!isNaN(val)) {
                        total += val;
                    }
                });
                document.getElementById('stockQuantity').value = total;
            }

            // Function to serialize all dynamic fields to JSON before submit
            function serializeSizeAndColor() {
                // Serialize Sizes
                const sizes = [];
                document.querySelectorAll('.size-checkbox:checked').forEach(checkbox => {
                    const size = checkbox.value;
                    sizes.push(size);
                });
                document.getElementById('sizeJson').value = JSON.stringify(sizes);

                // Serialize Colors and SKU Quantities
                const colors = [];
                const skuQuantities = {};
                document.querySelectorAll('#color-container .color-variant-card').forEach(card => {
                    const value = card.querySelector('.color-value').value;
                    colors.push(value);

                    const sizeQtys = {};
                    card.querySelectorAll('.sku-quantity-input').forEach(input => {
                        const size = input.dataset.size;
                        const qty = parseInt(input.value, 10) || 0;
                        sizeQtys[size] = qty;
                    });
                    skuQuantities[value] = sizeQtys;
                });
                document.getElementById('colorJson').value = JSON.stringify(colors);
                document.getElementById('skuQuantitiesJson').value = JSON.stringify(skuQuantities);
            }
        </script>
    </th:block>

</body>

</html>